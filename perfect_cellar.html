<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The River Shade | Perfect Cellar</title>
<link rel="stylesheet" href="style.css">
<link href="mobile.css" rel="stylesheet"/>
<style>
  body {
    color: #cfd8ff;
    font-family: "Crimson Text", serif;
    background-color: #000;
    overflow-x: hidden;
    padding: 2rem;
    text-align: center;
  }

  #fade-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    opacity: 0;
    z-index: 10;
    transition: opacity 2s ease-in-out;
    pointer-events: none;
  }

  #memory-text {
    position: fixed;
    top: 40%;
    width: 100%;
    text-align: center;
    font-size: 1.5em;
    color: #a9c8ff;
    opacity: 0;
    z-index: 20;
    transition: opacity 2s ease-in-out;
    pointer-events: none;
  }

  .alert-box {
    position: fixed;
    bottom: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(150, 180, 255, 0.1);
    border: 1px solid #a9c8ff;
    color: #d0e0ff;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1em;
    opacity: 0;
    z-index: 30;
    transition: opacity 1.5s ease-in-out;
    pointer-events: none;
  }

  .choice {
    color: #a9c8ff;
    text-decoration: none;
    border: 1px solid #a9c8ff;
    padding: 10px 20px;
    border-radius: 8px;
    display: inline-block;
    margin: 15px 10px;
    transition: background 0.4s;
    position: relative;
    z-index: 5;
    cursor: pointer;
  }

  .choice:hover {
    background: rgba(169,200,255,0.1);
  }

  .choice:active {
    transform: scale(0.98);
  }

  #inventory-box {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(10, 20, 40, 0.75);
    border: 1px solid #a9c8ff;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 0.9em;
    color: #a9c8ff;
    z-index: 1;
  }

  #content {
    max-width: 760px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  #content h1 {
    margin-bottom: 1.5rem;
  }

  #content p {
    margin: 1rem 0;
    line-height: 1.6;
  }

  #choices {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }
</style>
</head>
<body>

<div id="inventory-box">Inventory: <span id="inventory-list"></span></div>
<div id="fade-overlay"></div>
<div id="memory-text"></div>
<div class="alert-box" id="alert-box">Memory of the Drowned Promise recovered</div>

<div id="content">
  <!-- Content will be dynamically generated based on key possession -->
</div>

<script>
  // Mark as visited
  localStorage.setItem('visited_cellar', 'true');
  localStorage.setItem('last_perfect_visit', 'perfect_cellar');

  // --- SHARED INVENTORY FUNCTIONS (consistent across all perfect_ pages) ---
  function getInventory() {
    return JSON.parse(localStorage.getItem('inventory') || '[]');
  }

  function saveInventory(inv) {
    localStorage.setItem('inventory', JSON.stringify(inv));
    console.log("Inventory saved:", inv);
  }

  function hasItemInInventory(searchTerm) {
    const inv = getInventory();
    return inv.some(item => {
      const name = (typeof item === 'string') ? item : (item.name || item.id || '');
      return name.toLowerCase().includes(searchTerm.toLowerCase());
    });
  }

  function addToInventory(item) {
    const inv = getInventory();
    
    // Check if already has it
    const alreadyHas = inv.some(existing => {
      if (typeof existing === 'string' && typeof item === 'string') return existing === item;
      if (existing.id && item.id) return existing.id === item.id;
      if (existing.name && item.name) return existing.name === item.name;
      return false;
    });
    
    if (!alreadyHas) {
      inv.push(item);
      saveInventory(inv);
      updateInventoryDisplay();
      console.log("✓ Item added:", item);
      return true;
    }
    
    console.log("Item already in inventory:", item);
    return false;
  }

  function updateInventoryDisplay() {
    const inv = getInventory();
    const displayItems = inv.map(item => {
      if (typeof item === 'string') return item;
      if (item && item.name) return item.name;
      return JSON.stringify(item);
    });
    
    document.getElementById('inventory-list').textContent = 
      displayItems.length ? displayItems.join(', ') : 'Empty';
  }

  // Initialize display
  updateInventoryDisplay();

  // Live sync inventory
  window.addEventListener('storage', (event) => {
    if (event.key === 'inventory') {
      updateInventoryDisplay();
    }
  });

  const fadeOverlay = document.getElementById('fade-overlay');
  const memoryText = document.getElementById('memory-text');
  const alertBox = document.getElementById('alert-box');
  const content = document.getElementById('content');

  console.log("=== PERFECT CELLAR LOADED ===");

  // CHECK FOR KEY IMMEDIATELY ON PAGE LOAD
  function initializeCellar() {
    console.log("=== CELLAR INITIALIZATION ===");
    
    const hasKey = hasItemInInventory("rust") || hasItemInInventory("key");
    console.log("Has key:", hasKey);

    if (!hasKey) {
      console.log("NO KEY - Showing locked door");
      content.innerHTML = `
        <h1>The Cellar Door</h1>
        <p>The heavy door refuses to budge. You run your fingers over the lock — rusted, ancient, waiting.</p>
        <p>The iron is cold beneath your palm, and you can hear something faint beyond it... a whisper, perhaps. Or the memory of one.</p>
        <p><em>Perhaps if you had something to open it... a key made of rust, perhaps.</em></p>
        <div id="choices">
          <a href="perfect_path.html" class="choice">Return to the River Shade</a>
        </div>
      `;
    } else {
      console.log("HAS KEY - Showing cellar interior");
      content.innerHTML = `
        <h1>The cellar hums with quiet familiarity</h1>
        <p>The lantern's glow flickers over the damp stones. The air is heavy, aware of you.</p>
        <p>On the table, a fragment of paper stares back — ash-streaked, your handwriting half-formed.</p>

        <div id="choices">
          <a href="#" class="choice" id="inspect-paper">Inspect the fragment of paper</a>
          <a href="perfect_path.html" class="choice">Return to the River Shade</a>
        </div>
      `;

      // Set up the inspect button
      setTimeout(() => {
        const inspectBtn = document.getElementById('inspect-paper');
        if (!inspectBtn) {
          console.error("Inspect button not found!");
          return;
        }
        
        inspectBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log("Inspect button clicked!");

          content.innerHTML = `
            <h1>The cellar hums with quiet familiarity</h1>
            <p>The lantern sputters once, then steadies.</p>
            <p>The Shade stands in the archway, its form wavering like a reflection underwater.</p>
            <p><em>"I thought if I kept you here, you'd stop chasing ghosts,"</em> it murmurs. "But you never stopped listening."</p>
            <p>You look down — the fragment of paper in your hand hums faintly, pulsing with the same rhythm as your heartbeat.</p>
            <div id="choices"></div>
          `;

          // Check for River's Heart
          const hasHeart = hasItemInInventory("heart") || hasItemInInventory("river");
          console.log("Has River's Heart:", hasHeart);

          if (hasHeart) {
            // Check if memory already unlocked
            if (localStorage.getItem('memory_cellar') === 'true') {
              const choicesDiv = document.getElementById('choices');
              choicesDiv.innerHTML = `
                <p><em>The memory lingers, familiar now.</em></p>
                <a href="perfect_waterfront.html" class="choice">Follow the current to the Waterfront</a>
                <a href="perfect_path.html" class="choice">Return to the River Shade</a>
              `;
              return;
            }

            // Cinematic memory unlock
            setTimeout(() => {
              fadeOverlay.style.opacity = 1;

              setTimeout(() => {
                memoryText.textContent = "The ink bleeds, but the words remain.";
                memoryText.style.opacity = 1;
              }, 1500);

              setTimeout(() => {
                memoryText.textContent = "You remember the river before the silence.";
              }, 3500);

              setTimeout(() => {
                memoryText.textContent = "And the promise you drowned to keep.";
              }, 5500);

              setTimeout(() => {
                alertBox.style.opacity = 1;
              }, 8000);

              setTimeout(() => {
                console.log("=== APPLYING MEMORY UNLOCK ===");
                
                // SET FLAGS
                localStorage.setItem('memory_cellar', 'true');
                localStorage.setItem('cellarMemoryUnlocked', 'true');
                localStorage.setItem('perfectWaterfrontUnlocked', 'true');
                localStorage.setItem('visited_waterfront', 'true');
                
                // ADD JOURNAL TO INVENTORY - Critical fix!
                const journalAdded = addToInventory({
                  id: 'journal', 
                  name: 'Fragment of Memory'
                });
                
                console.log("Journal added:", journalAdded);
                console.log("Current inventory:", getInventory());

                // Hide overlays
                alertBox.style.opacity = 0;
                memoryText.style.opacity = 0;
                fadeOverlay.style.opacity = 0;
                
                // Show completion message
                content.innerHTML = `
                  <h1>The current pulls you forward</h1>
                  <p>The fragment of memory lingers, refusing to fade.</p>
                  <p style="color:#9cf; font-weight: bold; font-size: 1.1em;">
                    ✓ You acquired: Fragment of Memory (Journal)
                  </p>
                  <p style="color:#9fbfff; margin-top:1.5rem;">
                    <em>A new path opens... the waterfront calls to you.</em>
                  </p>
                  <div id="choices">
                    <a href="perfect_waterfront.html" class="choice">Follow the current to the Waterfront</a>
                    <a href="perfect_path.html" class="choice">Return to the River Shade</a>
                  </div>
                `;
                
                console.log("=== MEMORY UNLOCK COMPLETE ===");
              }, 11000);
            }, 2000);
          } else {
            // Need River's Heart
            console.log("Player doesn't have River's Heart");
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = `
              <p style="margin-top: 1.5rem;">
                <em>The paper stays silent. Perhaps something is missing... something with a pulse.</em>
              </p>
              <a href="perfect_path.html" class="choice">Return to the River Shade</a>
            `;
          }
        });
      }, 100);
    }
  }

  // Call initialization
  initializeCellar();
</script>
</body>
</html>
