<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The River Shade ‚Äì Perfect Path</title>
<link rel="stylesheet" href="style.css">
<link href="mobile.css" rel="stylesheet"/>
<style>
  body{background:#000;color:#ddd;font-family:Georgia,serif;padding:2rem;overflow-x:hidden;overflow-y:auto;}
  h1{font-size:1.8rem;text-align:center;margin-bottom:1rem;color:#cfeafc;}
  .fade-line{opacity:0;text-align:center;transition:opacity 2s ease;font-size:1.2rem;margin:0.8rem 0;}
  .choice{display:block;color:#9cf;text-decoration:none;margin:.8rem 0;padding:.4rem .8rem;border:1px solid #9cf;border-radius:8px;max-width:360px;}
  .choice:hover{opacity:.9;}
  #inventory-box,#memory-box{position:fixed;background:rgba(0,0,0,0.6);border:1px solid #666;padding:.6rem 1rem;border-radius:8px;font-family:monospace;color:#dfeeff;}
  #inventory-box{right:1rem;bottom:1rem;}
  #memory-box{left:1rem;bottom:1rem;text-align:left;}
  #reset-btn{position:fixed;top:12px;right:12px;padding:.4rem .6rem;border-radius:6px;background:#600;color:#fff;border:none;cursor:pointer;}
  #memory-alert{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:linear-gradient(180deg,#05203a,#0b2b45);color:#cfeafc;padding:10px 16px;border-radius:8px;opacity:0;transition:opacity .5s;z-index:1200;font-family:monospace;}
  #memory-alert.show{opacity:1;}
  .unlocked-badge{
    margin-left: 10px;
    padding: 2px 8px;
    border-radius: 6px;
    background: linear-gradient(180deg,#2b4b66,#153245);
    color:#dcefff;
    font-size:0.7rem;
    font-weight: bold;
    letter-spacing:.03em;
  }
</style>
</head>
<body data-scene="perfect_path">

<h1>The Perfect Path</h1>

<div id="intro">
  <div class="fade-line">You wake beneath the river's surface ‚Äì not drowning, but breathing as if the water itself remembers you.</div>
  <div class="fade-line">Shadows move above, slow and deliberate, waiting.</div>
  <div class="fade-line">Something whispers... your name?</div>
  <div class="fade-line">You stand, dripping and weightless.</div>
  <div class="fade-line">The world feels rearranged.</div>
  <div class="fade-line">The fragments pulse faintly, whispering new directions.</div>
</div>

<div id="links" style="display:none;"></div>
<button id="reset-btn">Reset Perfect Run</button>

<div id="inventory-box"></div>
<div id="memory-box"></div>
<div id="memory-alert"></div>

<script>
/* ---------- Fade-in intro ---------- */
function playIntro(callback){
  const lines=document.querySelectorAll('.fade-line');
  lines.forEach((line,idx)=>{
    setTimeout(()=>line.style.opacity='1',idx*2800);
  });
  setTimeout(()=>{
    document.getElementById('links').style.display='block';
    if(callback)callback();
  },lines.length*2800+200);
}

/* ---------- Inventory + memory UI ---------- */
function parseInventory(){
  try { 
    const raw=JSON.parse(localStorage.getItem('inventory')||'[]');
    return raw.map(i=>typeof i==='string'?{id:i,name:i.replace(/_/g,' ')}:i);
  } catch(e){
    return [];
  }
}

function refreshInventoryBox(){
  const inv=parseInventory();
  document.getElementById('inventory-box').innerHTML="<strong>Inventory</strong><br>"+(inv.length?inv.map(i=>i.name||i.id).join('<br>'):'(empty)');
}

function refreshMemoryBox(){
  const memNames={tavern:'Tavern',cellar:'Cellar',riverbank:'Riverbank',haunt:'Haunt',town:'Town'};
  let html="<strong>Memories</strong><br>";
  let count=0;
  for(const k in memNames){
    const got=localStorage.getItem('memory_'+k)==='true';
    html+=`${got?'‚úîÔ∏è':'‚¨ú'} ${memNames[k]}<br>`;
    if(got)count++;
  }
  html+=`<hr>${count}/5 collected`;
  document.getElementById('memory-box').innerHTML=html;
}

function showMemoryAlert(text){
  const el=document.getElementById('memory-alert');
  el.textContent=text;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),3600);
}

/* ---------- Build dynamic links ---------- */
function buildLinks(){
  const links=[];
  
  // Always show tavern
  links.push({href:'perfect_tavern.html',text:'üç∫ Enter the Tavern'});

  // Unlock Riverbank & Haunt after first Tavern visit
  const visitedTavern = localStorage.getItem('visited_tavern')==='true';
  if(visitedTavern){
    localStorage.setItem('visited_riverbank','true');
    localStorage.setItem('visited_haunt','true');
  }

  if(localStorage.getItem('visited_riverbank')==='true'){
    links.push({href:'perfect_riverbank.html',text:'üåä Walk to the Riverbank'});
  }
  
  if(localStorage.getItem('visited_haunt')==='true'){
    links.push({href:'perfect_haunt.html',text:'üå´Ô∏è Wander into the Haunt'});
  }

  // ONLY unlock Town & Cellar after ACTUALLY visiting (not just having flags set) Riverbank OR Haunt
  // Check if player has returned from either location
  const lastVisit = localStorage.getItem('last_perfect_visit');
  const returnedFromRiver = lastVisit === 'perfect_riverbank';
  const returnedFromHaunt = lastVisit === 'perfect_haunt';
  
  if(returnedFromRiver || returnedFromHaunt){
    localStorage.setItem('visited_cellar','true');
    localStorage.setItem('visited_town','true');
  }

  // Check if cellar is unlocked
  if(localStorage.getItem('visited_cellar')==='true'){
    const isNew = (returnedFromRiver || returnedFromHaunt) && !localStorage.getItem('cellar_badge_shown');
    links.push({
      href:'perfect_cellar.html',
      text:'üîí Descend to the Cellar',
      badge: isNew ? 'NEW' : null
    });
    if(isNew) localStorage.setItem('cellar_badge_shown','true');
  }

  // Check if town is unlocked
  if(localStorage.getItem('visited_town')==='true'){
    const isNew = (returnedFromRiver || returnedFromHaunt) && !localStorage.getItem('town_badge_shown');
    links.push({
      href:'perfect_town.html',
      text:'üèôÔ∏è Return to the Town',
      badge: isNew ? 'NEW' : null
    });
    if(isNew) localStorage.setItem('town_badge_shown','true');
  }

  // Check for Cellar memory completion -> unlock Waterfront
  const cellarMemDone = localStorage.getItem('memory_cellar')==='true';
  if(cellarMemDone){
    localStorage.setItem('visited_waterfront','true');
  }

  if(localStorage.getItem('visited_waterfront')==='true'){
    const isNew = cellarMemDone && !localStorage.getItem('waterfront_badge_shown');
    links.push({
      href:'perfect_waterfront.html',
      text:'üåë Walk to the Waterfront',
      badge: isNew ? 'NEW' : null
    });
    if(isNew) localStorage.setItem('waterfront_badge_shown','true');
  }

  // Check for all 5 memories -> unlock bridge
  const allMemCollected = ['tavern','cellar','riverbank','haunt','town']
    .every(k => localStorage.getItem('memory_'+k)==='true');
  if(allMemCollected){
    localStorage.setItem('visited_bridge','true');
  }

  if(localStorage.getItem('visited_bridge')==='true'){
    links.push({href:'perfect_bridge.html',text:'üåâ Approach the Bridge'});
  }

  // Render
  const cont=document.getElementById('links');
  cont.innerHTML='';
  links.forEach(({href,text,badge})=>{
    const a=document.createElement('a');
    a.className='choice';
    a.href=href;
    a.innerHTML=text;
    if(badge){
      const sp=document.createElement('span');
      sp.className='unlocked-badge';
      sp.textContent=badge;
      a.appendChild(sp);
    }
    cont.appendChild(a);
  });

  // Show special alert if bridge just unlocked
  if(allMemCollected && !localStorage.getItem('bridge_alert_shown')){
    setTimeout(()=>{
      showMemoryAlert('All memories collected. The bridge awaits.');
      localStorage.setItem('bridge_alert_shown','true');
    },1000);
  }
}

/* ---------- Reset ---------- */
function resetPerfect(){
  if(!confirm('Reset all Perfect Path progress and clear inventory?'))return;
  ['memory_tavern','memory_cellar','memory_riverbank','memory_haunt','memory_town',
   'visited_tavern','visited_riverbank','visited_haunt','visited_town','visited_cellar','visited_waterfront','visited_bridge',
   'perfect_unlock_phase','last_perfect_visit','perfect_intro_played',
   'riverbankMemoryUnlocked','cellarMemoryUnlocked','tavernMemoryUnlocked',
   'hauntMemoryUnlocked','townMemoryUnlocked','perfectCellarUnlocked','perfectTownUnlocked','perfectWaterfrontUnlocked',
   'cellar_badge_shown','town_badge_shown','waterfront_badge_shown','bridge_alert_shown'].forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('inventory');
  showMemoryAlert('The path fades to black...');
  setTimeout(()=>location.reload(),1400);
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  refreshInventoryBox();
  refreshMemoryBox();
  const introPlayed=localStorage.getItem('perfect_intro_played')==='true';
  if(!introPlayed){
    localStorage.setItem('perfect_intro_played','true');
    playIntro(buildLinks);
  } else {
    document.getElementById('intro').style.display='none';
    document.getElementById('links').style.display='block';
    buildLinks();
  }
  document.getElementById('reset-btn').addEventListener('click',resetPerfect);
});
</script>

</body>
</html>
