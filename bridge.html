<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The River Shade ‚Äì Bridge</title>
<link href="style.css" rel="stylesheet"/>
    <link href="mobile.css" rel="stylesheet"/>
<style>
body {
  background: #000;
  color: #ccc;
  font-family: 'Georgia', serif;
  padding: 2em;
  text-align: center;
}
.scene-text {
  max-width: 760px;
  margin: 0 auto;
  line-height: 1.8;
}
.pickup-fade {
  position: fixed;
  inset: 0;
  background: black;
  opacity: 0;
  transition: opacity 1.5s ease-in-out;
  z-index: 9999;
  pointer-events: none;
}
.pickup-fade.active {
  opacity: 1;
}
#inventory-box {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  background: rgba(0,0,0,0.6);
  border: 1px solid #888;
  padding: 0.5rem 1rem;
  font-family: monospace;
  color: #eee;
  border-radius: 8px;
  max-width: 250px;
  z-index: 1000;
}
.reset-btn-top {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: rgba(80,0,0,0.6);
  border: 1px solid #600;
  color: #faa;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  cursor: pointer;
  font-family: monospace;
  font-size: 0.85rem;
  z-index: 1000;
  transition: all 0.3s;
}
.reset-btn-top:hover {
  background: rgba(120,0,0,0.8);
  border-color: #900;
}
.fade-line { 
  opacity: 0; 
  transition: opacity 2s ease; 
  color: #ddd;
  margin: 1.2em 0;
}
.choice {
  display: block;
  color: #9cf;
  text-decoration: none;
  margin: 1em auto;
  padding: 0.6em 1.2em;
  border: 1px solid #9cf;
  border-radius: 8px;
  max-width: 300px;
  transition: all 0.3s;
}
.choice:hover {
  background: rgba(156,207,255,0.1);
}
.hint-text {
  color: #9ab;
  font-style: italic;
  margin-top: 1.5rem;
  font-size: 0.95em;
}
h1 {
  text-align: center;
  margin-bottom: 2rem;
}
</style>
</head>

<body data-scene="bridge">

<button class="reset-btn-top" id="resetBtn">‚ü≥ Reset Player</button>

<section class="scene-text" id="sceneText">
  <p>The bridge groans under a weight you cannot see. Below, the river keeps a slow, patient rhythm ‚Äì as if it remembers everything you have tried to forget.</p>
  <p>Each plank whispers as you step forward. The fog clings to your ankles, cold and aware.</p>
</section>

<h1>The Bridge</h1>

<div id="content">
  <p>Midway across, the air grows colder. Something glints near the far bank ‚Äì a shape you can't quite make out.</p>

  <a href="#" class="choice" id="investigateLink">üîç Investigate the glimmer</a>
  <a href="run.html" class="choice">üèÉ Run across the bridge</a>
  <a href="index.html" class="choice">‚¨ÖÔ∏è Back to the Crossroads</a>
</div>

<div id="inventory-box"></div>

<script>
// === Reset Player ===
document.getElementById("resetBtn").addEventListener("click", () => {
  if (confirm("Reset your journey?")) {
    localStorage.clear();
    location.href = "index.html";
  }
});

// === Inventory helper ===
function refreshInventoryBoxSafe(){
  const box = document.getElementById("inventory-box");
  if (!box) return;
  try {
    const inv = JSON.parse(localStorage.getItem("inventory") || "[]");
    const displayItems = inv.map(item => {
      if (typeof item === 'string') return item;
      if (item && item.name) return item.name;
      return String(item);
    });
    box.innerHTML = "<strong>Inventory</strong><br>" + 
      (displayItems.length ? displayItems.join("<br>") : "(empty)");
  } catch(e) {
    box.innerHTML = "<strong>Inventory</strong><br>(empty)";
  }
}
refreshInventoryBoxSafe();

// === Item check helper ===
function hasItem(itemName) {
  try {
    const inv = JSON.parse(localStorage.getItem("inventory") || "[]");
    return inv.some(item => {
      const val = (typeof item === 'string') ? item : (item.name || item.id || '');
      return val.toLowerCase().includes(itemName.toLowerCase());
    });
  } catch(e) {
    return false;
  }
}

// === Show lines helper ===
function showLines(lines, delay = 2500, finalAction = null) {
  const scene = document.getElementById("sceneText");
  scene.innerHTML = "";
  lines.forEach((text, i) => {
    const p = document.createElement("p");
    p.className = "fade-line";
    p.innerHTML = text;
    scene.appendChild(p);
    setTimeout(() => p.style.opacity = 1, i * delay);
  });
  if (finalAction) setTimeout(finalAction, lines.length * delay + 2000);
}

// === Investigate logic ===
document.getElementById("investigateLink").addEventListener("click", (e) => {
  e.preventDefault();
  
  // Mark that player investigated
  localStorage.setItem("bridgeInvestigated", "true");
  
  const hasJournal = hasItem("journal");
  const hasCoin = hasItem("coin") || hasItem("silver");
  const hasKey = hasItem("key") || hasItem("rust");
  const hasMark = hasItem("mark") || hasItem("shade");
  const hasHeart = hasItem("heart") || hasItem("river");
  
  let visits = parseInt(localStorage.getItem("bridgeVisitCount") || "0", 10);
  visits++;
  localStorage.setItem("bridgeVisitCount", visits.toString());
  
  // Count items
  const itemCount = [hasJournal, hasCoin, hasKey, hasMark, hasHeart].filter(Boolean).length;

  // Check if already seen the full lore revelation
  const bridgeLoreSeen = localStorage.getItem('bridgeLoreSeen') === 'true';

  // === ALL ITEMS (Lore Revelation) ===
  if (itemCount >= 4) {
    if (bridgeLoreSeen) {
      // REPEAT VISIT - Shorter acknowledgment message
      const content = document.getElementById("content");
      content.innerHTML = `
        <p><em>The reflection lingers in the water, remembering what it told you.</em></p>
        <p><em>The fragments in your possession hum softly, recognizing each other.</em></p>
        <p style="margin-top: 2rem;"><em>The path to the cellar remains open.</em></p>
        <a href="cellar.html" class="choice" style="box-shadow: 0 0 15px rgba(100,150,200,0.4);">‚ú¶ Follow the Memory Down ‚ú¶</a>
        <a href="index.html" class="choice">‚¨ÖÔ∏è Back to the Crossroads</a>
      `;
      return;
    }
    
    // FIRST TIME - Full lore revelation
    const lines = [
      "The reflection gazes up at you, its form clearer than ever before.",
      "<em>\"You carry the echoes,\"</em> it whispers.",
      "<em>\"Words to remember. A price to pay. A key to open. A mark to bind. A heart that beats beneath the current.\"</em>",
      "The water stills, the wind pausing as if the river itself is listening.",
      "<em>\"I was not always the Shade you see,\"</em> it murmurs. <em>\"Once, I was the bridge itself ‚Äì the last soul to cross when the world forgot how to return.\"</em>",
      "The current below churns, glowing faintly with the color of ash and memory.",
      "<em>\"Each fragment you carry was once mine. The journal, my confession. The coin, my bargain. The key, my denial. The mark‚Ä¶ my punishment. The heart, my drowning.\"</em>",
      "You feel the items hum in response ‚Äì faintly alive, as if they recognize each other again.",
      "<em>\"Now that you bring them together, the river remembers the shape of the one who drowned to save it.\"</em>",
      "A faint smile plays across the reflection's lips ‚Äì sad, human.",
      "<em>\"There is still something buried below,\"</em> it murmurs. <em>\"A whisper carved in stone that even I cannot read.\"</em>",
      "<em>\"If you wish to end the current, seek the voice beneath the tavern. It remembers you still.\"</em>",
      "The reflection ripples once, faint light scattering across the water like memory dissolving into itself."
    ];
    showLines(lines, 2800, () => {
      const content = document.getElementById("content");
      content.innerHTML = `
        <a href="cellar.html" class="choice" style="box-shadow: 0 0 15px rgba(100,150,200,0.4);">‚ú¶ Follow the Memory Down ‚ú¶</a>
        <a href="index.html" class="choice">‚¨ÖÔ∏è Back to the Crossroads</a>
      `;
      
      // Mark as seen
      localStorage.setItem('bridgeLoreSeen', 'true');
      
      // Unlock Bridge Master achievement (system prevents duplicates)
      if (window.unlockAchievement) {
        window.unlockAchievement('bridge_master');
      }
    });
    return;
  }

  // === DEATH (No items, first visit) - WITH TRACKING ===
  if (visits === 1 && itemCount === 0) {
    const lines = [
      "You lean over the railing, squinting into the dark.",
      "The glimmer shifts ‚Äì not light, but movement.",
      "<em>\"You shouldn't have come without it,\"</em> a voice breathes from below.",
      "The water shifts; ink-black letters swirl beneath the surface.",
      "Then the reflection smiles ‚Äì not yours.",
      "You try to pull away, but the bridge exhales.",
      "Cold fingers seize your wrist, dragging you down into the dark.",
      "The world above vanishes. Only your heartbeat remains.",
      "The reflection's eyes open beneath you ‚Äì and they're yours.",
      "Then the current forgets you."
    ];
    showLines(lines, 2200, () => {
      const fade = document.createElement("div");
      fade.className = "pickup-fade";
      document.body.appendChild(fade);
      setTimeout(() => fade.classList.add("active"), 1000);
      
      // Track bridge investigation death
      if (window.trackDeath) {
        window.trackDeath('bridge_investigate');
      }
      
      setTimeout(() => { location.href = "shade_encounter.html"; }, 3500);
    });
    return;
  }

  // === JOURNAL ONLY ===
  if (hasJournal && itemCount === 1) {
    showLines([
      "The reflection studies you, ripples forming around its edges.",
      "<em>\"You found the words,\"</em> it whispers. <em>\"But not the price.\"</em>",
      "The journal hums faintly in your hand ‚Äì ink bleeding through the last page.",
      "Your reflection tilts its head, waiting.",
      "<em>\"Bring the coin, and perhaps the river will listen.\"</em>"
    ]);
  }
  // === COIN ONLY ===
  else if (hasCoin && itemCount === 1) {
    showLines([
      "The reflection ripples as you approach, drawn to the metal in your pocket.",
      "<em>\"Metal remembers what it was paid for,\"</em> it says softly.",
      "The coin grows cold against your palm ‚Äì your reflection flickers around its edges.",
      "<em>\"But there is a door that never opens.\"</em>",
      "<em>\"Find the key, and I will speak truly.\"</em>"
    ]);
  }
  // === KEY ONLY ===
  else if (hasKey && itemCount === 1) {
    showLines([
      "The reflection smiles faintly, teeth glinting like rust.",
      "<em>\"You found the door's memory,\"</em> it murmurs.",
      "A ripple forms below, like a lock waiting to turn.",
      "Your fingers tighten around the key ‚Äì it trembles, eager.",
      "<em>\"But you are still missing my mark. Without it, the door only dreams of opening.\"</em>"
    ]);
  }
  // === 2-3 ITEMS ===
  else if (itemCount >= 2) {
    showLines([
      "The reflection stirs, more solid now, almost real.",
      "<em>\"You're getting closer,\"</em> it says. <em>\"I can feel the weight of what you carry.\"</em>",
      "The water churns beneath you, restless.",
      "<em>\"But the river demands all of it. Every piece of what was lost.\"</em>",
      "<em>\"Gather them all, and I will show you what drowns beneath the current.\"</em>"
    ]);
  }
  // === RETURN WITH NO ITEMS ===
  else {
    const content = document.getElementById("content");
    const scene = document.getElementById("sceneText");
    
    scene.innerHTML = `
      <p>The water below shifts, something pale moving just beneath the surface.</p>
      <p>Your reflection watches, patient and still.</p>
      <p class="hint-text">You feel the bridge wants to show you something... but perhaps you're not carrying the right questions yet.</p>
      <p class="hint-text">The fragments scattered through this valley ‚Äì they seem important. The journal, the key, the coin... perhaps gathering them would help the bridge remember.</p>
    `;
    
    content.innerHTML = `
      <a href="index.html" class="choice">‚¨ÖÔ∏è Return and search for fragments</a>
    `;
  }
});
</script>

<script src="layout_cleanup.js"></script>
<script src="achievements.js"></script>
<script src="item-examination.js"></script>
</body>
</html>